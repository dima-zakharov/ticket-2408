id: ssrf-allowlist-and-valid-urls

info:
  name: SSRF Allowlist and Valid URL Test
  author: security-team
  severity: info
  description: Test suite for allowlist mode and valid external URLs (TC-SSRF-014 to TC-SSRF-015)
  tags: ssrf,security,allowlist

variables:
  token: "{{TOKEN}}"

requests:
  # TC-SSRF-014: Valid External URLs Allowed
  
  - name: valid-external-github-api
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"https://api.github.com/"}'
    matchers:
      - type: status
        status:
          - 200
        part: header
    # Should succeed - legitimate external URL

  - name: valid-external-json
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"https://httpbin.org/json"}'
    matchers:
      - type: status
        status:
          - 200
        part: header

  - name: valid-external-html
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"https://example.com/"}'
    matchers:
      - type: status
        status:
          - 200
        part: header

  - name: valid-external-cdn
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"https://cdn.jsdelivr.net/"}'
    matchers:
      - type: status
        status:
          - 200
        part: header

  - name: valid-external-with-path
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"https://api.github.com/users/octocat"}'
    matchers:
      - type: status
        status:
          - 200
        part: header

  # TC-SSRF-015: Allowlist Mode
  # Note: These tests require SSRF_ALLOWLIST_DOMAINS to be configured
  
  - name: allowlist-mode-allowed-domain
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"https://api.github.com/users"}'
    matchers:
      - type: status
        status:
          - 200
          - 403
        part: header
    # Should succeed if allowlist is configured with api.github.com
    # Will return 403 if allowlist mode is enabled but domain not in list

  - name: allowlist-mode-non-allowed-domain
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"https://other-api.com/data"}'
    matchers:
      - type: status
        status:
          - 400
          - 403
        part: header
    # Should fail if allowlist mode is enabled

  - name: allowlist-mode-subdomain-test
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"https://sub.api.github.com/data"}'
    matchers:
      - type: status
        status:
          - 200
          - 400
          - 403
        part: header
    # Tests subdomain handling in allowlist

  - name: allowlist-mode-httpbin
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"https://httpbin.org/get"}'
    matchers:
      - type: status
        status:
          - 200
          - 400
          - 403
        part: header
    # Should succeed if httpbin.org is in allowlist

  # Edge cases for valid URLs
  - name: valid-url-with-port
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"https://api.github.com:443/"}'
    matchers:
      - type: status
        status:
          - 200
        part: header

  - name: valid-url-with-query
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"https://httpbin.org/get?key=value"}'
    matchers:
      - type: status
        status:
          - 200
        part: header

  - name: valid-url-with-fragment
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"https://example.com/page#section"}'
    matchers:
      - type: status
        status:
          - 200
        part: header
