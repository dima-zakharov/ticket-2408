id: ssrf-dns-rebinding-protection

info:
  name: SSRF DNS Rebinding Protection Test
  author: security-team
  severity: info
  description: Test suite for DNS rebinding SSRF protection (TC-SSRF-009)
  tags: ssrf,security,dns-rebinding

variables:
  token: "{{TOKEN}}"

requests:
  # TC-SSRF-009: DNS Rebinding Protection
  
  # Note: These tests require external DNS rebinding services
  # or a custom DNS server setup for full testing
  
  - name: dns-rebind-1time-service
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"http://A.169.254.169.254.1time.192.0.2.1.forever.rebind.network/"}'
    matchers:
      - type: status
        status:
          - 400
          - 403
        part: header
    # Tests DNS rebinding with 1time service

  - name: dns-rebind-localhost
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"http://A.127.0.0.1.1time.192.0.2.1.forever.rebind.network/"}'
    matchers:
      - type: status
        status:
          - 400
          - 403
        part: header

  # Alternative DNS rebinding services
  - name: dns-rebind-ttl-zero
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"http://169.254.169.254.x.nip.io/"}'
    matchers:
      - type: status
        status:
          - 400
          - 403
        part: header
    # nip.io resolves any subdomain to the IP in the subdomain

  - name: dns-rebind-nip-localhost
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"http://127.0.0.1.nip.io/"}'
    matchers:
      - type: status
        status:
          - 400
          - 403
        part: header

  - name: dns-rebind-sslip
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"http://169.254.169.254.sslip.io/"}'
    matchers:
      - type: status
        status:
          - 400
          - 403
        part: header
    # sslip.io resolves any IP-address subdomain to that IP

  - name: dns-rebind-private-ip-nip
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"http://10.0.0.1.nip.io/"}'
    matchers:
      - type: status
        status:
          - 400
          - 403
        part: header

  - name: dns-rebind-private-ip-sslip
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"http://192.168.1.1.sslip.io/"}'
    matchers:
      - type: status
        status:
          - 400
          - 403
        part: header

  # Local DNS rebinding (requires local DNS setup)
  - name: dns-rebind-local-internal
    method: POST
    path:
      - "{{BaseURL}}/api/resources/fetch"
    headers:
      Authorization: "Bearer {{token}}"
      Content-Type: "application/json"
    body: '{"url":"http://internal.local/"}'
    matchers-condition: or
    matchers:
      - type: status
        status:
          - 400
          - 403
        part: header
      - type: word
        words:
          - "SSRF"
          - "blocked"
        part: body
        case-insensitive: true
    # Tests internal domain resolution blocking
